<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Horas Extras - Estúdio Infocus</title>
    <!-- 1. Carrega o Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Carrega a fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 3. Adiciona SheetJS para exportar/importar de XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 4. ADICIONA BIBLIOTECAS PARA GERAÇÃO DE PDF BAIXÁVEL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Usa a versão modular do jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Centraliza o texto dentro dos inputs de hora */
        input[type="time"], select {
            text-align: center;
            border: 1px solid #e2e8f0; /* borda sutil */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem;
        }
        
        input[type="time"] {
            width: 100px; /* Largura fixa para inputs de hora */
        }
        
        /* Remove setas do input de hora no Chrome/Safari */
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
            background: none;
        }

        /* --- CORES DE DIAS ESPECIAIS --- */
        /* Domingos */
        .is-sunday {
            background-color: #fecaca; /* red-200 */
        }
        /* Feriados Nacionais */
        .is-national-holiday {
            background-color: #fef08a; /* yellow-200 */
        }
        /* Feriados Municipais (Piracanjuba, GO) */
        .is-municipal-holiday {
            background-color: #bfdbfe; /* blue-200 */
        }
        /* --- FIM CORES --- */


        /* Estilos de impressão e PDF (Otimizados para Saída Limpa) */
        @media print {
            body {
                font-size: 10pt;
                color: #000;
                background-color: #fff;
            }
            /* Garante que controles e mensagens fiquem escondidos */
            .print-hidden, #message-container { 
                display: none !important;
            }
            .print-container {
                width: 100%;
                max-width: 100%;
                padding: 0;
                margin: 0;
                box-shadow: none;
                border: none;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                box-shadow: none;
            }
            th, td {
                border: 1px solid #ccc !important;
                padding: 4px 6px;
                color: #000;
                background-color: #fff !important; 
            }
            /* Re-aplica cores de fundo específicas na impressão/PDF */
            .is-sunday td, .is-national-holiday td, .is-municipal-holiday td {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .is-sunday td { background-color: #fecaca !important; }
            .is-national-holiday td { background-color: #fef08a !important; }
            .is-municipal-holiday td { background-color: #bfdbfe !important; }

            input[type="time"] {
                border: none;
                padding: 0;
                width: auto;
                background-color: transparent !important;
                text-align: center;
            }
            input[type="time"]:invalid {
                color: #000;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-lg print-container">
        
        <!-- Cabeçalho -->
        <header class="text-center mb-6 border-b pb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Estúdio Infocus</h1>
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 mt-2">Planilha de Horas Extras</h2>
            <p class="text-lg text-gray-600 mt-1">Matheus Pica de Marreta</p>
        </header>

        <!-- Controles de Navegação (Escondidos na impressão e na captura do PDF) -->
        <nav class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 print-hidden space-y-4 md:space-y-0">
            
            <!-- Seletores de Data -->
            <div class="flex items-center space-x-4">
                <label for="year-select" class="text-lg font-medium text-gray-700">Ano:</label>
                <select id="year-select" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg">
                    <!-- Gerado pelo JS -->
                </select>

                <label for="month-select" class="text-lg font-medium text-gray-700">Mês:</label>
                <select id="month-select" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg">
                    <!-- Gerado pelo JS -->
                </select>
            </div>
            
            <!-- Botões de Ação -->
            <div class="flex flex-wrap space-x-2 sm:space-x-4 mt-4 md:mt-0">
                
                <!-- Input de Arquivo Escondido para Importação -->
                <input type="file" id="xlsx-file-input" accept=".xlsx" class="hidden" onchange="handleFileImport(event)">

                <button onclick="document.getElementById('xlsx-file-input').click()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 sm:px-6 rounded-lg shadow transition duration-200 text-sm sm:text-base mb-2">
                    Importar do XLSX
                </button>
                <button onclick="exportToXLSX()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 sm:px-6 rounded-lg shadow transition duration-200 text-sm sm:text-base mb-2">
                    Exportar para XLSX
                </button>
                <!-- NOVO BOTÃO PARA GERAR ARQUIVO PDF -->
                <button onclick="generatePDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 sm:px-6 rounded-lg shadow transition duration-200 text-sm sm:text-base mb-2">
                    Gerar Arquivo PDF
                </button>
                <!-- BOTÃO DE IMPRESSÃO (FUNÇÃO ANTIGA) -->
                <button onclick="window.print()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 sm:px-6 rounded-lg shadow transition duration-200 text-sm sm:text-base">
                    Imprimir Planilha
                </button>
            </div>
        </nav>

        <!-- Container de Mensagem (Para Pop-ups) -->
        <div id="message-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center print-hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="message-text" class="text-lg font-medium text-gray-700 mb-4"></p>
                <button id="message-action-button" onclick="closeMessage()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    OK
                </button>
            </div>
        </div>

        <!-- Container da Planilha -->
        <div id="sheet-container" class="overflow-x-auto">
            <p class="text-center py-10 text-xl font-medium text-blue-600">Carregando dados...</p>
        </div>

        <!-- Rodapé com Totais -->
        <div id="sheet-footer" class="mt-6 border-t pt-4">
            <!-- Totalizador será inserido aqui -->
        </div>

        <footer class="text-center text-xs text-gray-400 mt-8 print-hidden">
            Feriados nacionais (Brasil) fornecidos por BrasilAPI. Feriado municipal de Piracanjuba, GO (15/08) fixo.
        </footer>
    </div>

    <script type="text/javascript">
        
        let currentMonthData = {};
        
        const DIAS_SEMANA = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        const HORA_BASE_SEMANA = 8 * 60; 
        const HORA_BASE_SABADO = 4 * 60; 
        const HORA_BASE_DOMINGO = 0;
        const HORA_BASE_FERIADO = 0;

        const MUNICIPAL_HOLIDAYS = {
            '08-15': "Nossa Senhora D'Abadia (Padroeira do Município)" 
        };
        const holidaysCache = {}; 
        
        // Elementos da DOM
        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');
        const sheetContainer = document.getElementById('sheet-container');
        const sheetFooter = document.getElementById('sheet-footer');
        const messageContainer = document.getElementById('message-container');
        const messageText = document.getElementById('message-text');
        const messageActionButton = document.getElementById('message-action-button');


        // --- FUNÇÕES DE MENSAGEM ---
        function showMessage(text, buttonText = "OK", showButton = true) {
            messageText.textContent = text;
            messageActionButton.textContent = buttonText;
            messageActionButton.onclick = closeMessage; 

            if (showButton) {
                messageActionButton.classList.remove('hidden');
            } else {
                messageActionButton.classList.add('hidden');
            }

            messageContainer.classList.remove('hidden');
            messageContainer.classList.add('flex');
        }

        window.closeMessage = function() {
            messageContainer.classList.add('hidden');
            messageContainer.classList.remove('flex');
        }

        // --- GERAÇÃO DE PDF (FUNÇÃO OTIMIZADA PARA CONTEÚDO LONGO) ---
        window.generatePDF = async function() {
            if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                showMessage("As bibliotecas de geração de PDF não foram carregadas. A função falhou.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const mainContent = document.querySelector('.print-container');
            
            showMessage("Gerando PDF... Por favor, aguarde.", "...", false); 

            // 1. Prepara a Captura: Esconde controles e garante que todo o conteúdo seja visível
            const hiddenElements = document.querySelectorAll('.print-hidden');
            const originalOverflow = sheetContainer.style.overflowX;
            const originalHeight = sheetContainer.style.height;

            hiddenElements.forEach(el => el.style.display = 'none');
            
            // Remove scrollbars e garante que o container expanda para o conteúdo total
            sheetContainer.style.overflowX = 'visible';
            sheetContainer.style.height = 'auto'; 

            try {
                // 2. Capturar o conteúdo principal (aumenta a escala para melhor nitidez)
                const canvas = await html2canvas(mainContent, { 
                    scale: 3, 
                    logging: false,
                    useCORS: true 
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                
                // Configurações do PDF (Paisagem A4)
                const pdf = new jsPDF('l', 'mm', 'a4'); 
                const pdfWidth = 297; // Largura A4 paisagem em mm
                const pdfHeight = 210; // Altura A4 paisagem em mm
                
                // Calcula a altura da imagem no PDF, mantendo a proporção.
                const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                
                let position = 0;
                let heightLeft = imgHeight;

                // 3. Adicionar imagem ao PDF com paginação
                while (heightLeft > 0) {
                    // Adiciona a imagem no ponto de corte
                    pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                    
                    if (heightLeft > 0) {
                        pdf.addPage();
                        // Move a posição para "cortar" a imagem no canvas original
                        position = -((imgHeight - heightLeft) * (pdfWidth / imgHeight));
                    }
                }

                // 4. Salvar o arquivo
                const monthText = monthSelect.options[monthSelect.selectedIndex].text;
                const yearText = yearSelect.value;
                pdf.save(`Planilha_Horas_Infocus_${monthText}_${yearText}.pdf`);
                
            } catch (error) {
                console.error("Erro ao gerar o PDF:", error);
                showMessage("Ocorreu um erro ao gerar o PDF. Verifique o console para mais detalhes.");
            } finally {
                // 5. Limpeza: Restaura estilos e fecha o loading
                sheetContainer.style.overflowX = originalOverflow;
                sheetContainer.style.height = originalHeight;
                hiddenElements.forEach(el => el.style.display = ''); 
                closeMessage();
            }
        }


        // --- LÓGICA DE PERSISTÊNCIA (SAVE/LOAD) USANDO localStorage (MANTIDA) ---

        const getLocalStorageKey = (year, month) => {
            const monthId = `${year}-${String(month).padStart(2, '0')}`;
            return `infocus_timesheet_${monthId}`;
        };

        let saveTimeout;
        function debounce(func, timeout = 1000) {
            return (...args) => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        function loadMonthData(year, month) {
            const key = getLocalStorageKey(year, month);
            const savedJson = localStorage.getItem(key);
            
            if (savedJson) {
                try {
                    currentMonthData = JSON.parse(savedJson);
                    return currentMonthData;
                } catch (e) {
                    console.error("Erro ao carregar dados do localStorage:", e);
                    currentMonthData = {};
                    return {};
                }
            } else {
                currentMonthData = {};
                return {};
            }
        }

        function saveDailyEntry(year, month, day, entryData) {
            const key = getLocalStorageKey(year, month);
            currentMonthData[day] = entryData;
            
            try {
                localStorage.setItem(key, JSON.stringify(currentMonthData));
            } catch (e) {
                console.error("Erro ao salvar no localStorage:", e);
            }
        }
        const debouncedSave = debounce(saveDailyEntry, 1000); 

        function saveFullMonthData(year, month, dataObject) {
            const key = getLocalStorageKey(year, month);
            try {
                localStorage.setItem(key, JSON.stringify(dataObject));
                currentMonthData = dataObject; 
            } catch (e) {
                console.error("Erro ao salvar dados completos no localStorage:", e);
            }
        }

        // --- FUNÇÕES DE UTILIADDE E CÁLCULO (MANTIDA) ---

        function parseTime(timeStr) {
            if (!timeStr) return 0;
            try {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return (hours * 60) + minutes;
            } catch (e) {
                return 0;
            }
        }

        function formatMinutes(totalMinutes, showSign = false) {
            if (isNaN(totalMinutes)) totalMinutes = 0;

            const sign = totalMinutes < 0 ? "-" : (showSign ? "+" : "");
            const absMinutes = Math.abs(totalMinutes);
            
            const hours = Math.floor(absMinutes / 60);
            const minutes = Math.round(absMinutes % 60);

            const hStr = hours.toString().padStart(2, '0');
            const mStr = minutes.toString().padStart(2, '0');
            
            return sign + `${hStr}:${mStr}`;
        }

        function calculateRow(row, shouldSave = false) {
            const inputs = {
                in1: row.querySelector('[data-col="in1"]').value,
                out1: row.querySelector('[data-col="out1"]').value,
                in2: row.querySelector('[data-col="in2"]').value,
                out2: row.querySelector('[data-col="out2"]').value,
            };

            const minIn1 = parseTime(inputs.in1);
            const minOut1 = parseTime(inputs.out1);
            const minIn2 = parseTime(inputs.in2);
            const minOut2 = parseTime(inputs.out2);

            let totalWorkedMinutes = 0;

            if (minOut1 > minIn1) {
                totalWorkedMinutes += (minOut1 - minIn1);
            }
            if (minOut2 > minIn2) {
                totalWorkedMinutes += (minOut2 - minIn2);
            }
            
            const baseMinutes = parseInt(row.dataset.baseMinutes, 10);
            let overtimeMinutes = 0;

            if (totalWorkedMinutes > 0) {
                 overtimeMinutes = totalWorkedMinutes - baseMinutes;
            }

            const totalWorkedCell = row.querySelector('.total-worked');
            const overtimeCell = row.querySelector('.overtime');

            totalWorkedCell.textContent = formatMinutes(totalWorkedMinutes, false);
            overtimeCell.textContent = formatMinutes(overtimeMinutes, true);

            overtimeCell.classList.remove('text-green-600', 'text-red-600', 'text-gray-700');
            if (overtimeMinutes > 0) {
                overtimeCell.classList.add('text-green-600');
            } else if (overtimeMinutes < 0) {
                overtimeCell.classList.add('text-red-600');
            } else {
                overtimeCell.classList.add('text-gray-700');
            }
            
            if (shouldSave) {
                const rowId = row.id.replace('row-', '');
                const day = parseInt(rowId, 10);
                const year = parseInt(yearSelect.value, 10);
                const month = parseInt(monthSelect.value, 10);
                
                const entryData = {
                    in1: inputs.in1,
                    out1: inputs.out1,
                    in2: inputs.in2,
                    out2: inputs.out2,
                };
                
                debouncedSave(year, month, day, entryData);
            }
            
            updateTotalOvertime();
        }

        function updateTotalOvertime() {
            let totalMonthOvertime = 0;
            
            document.querySelectorAll('#sheet-body tr').forEach(row => {
                 const overtimeCell = row.querySelector('.overtime');
                 const timeStr = overtimeCell.textContent;

                if (timeStr === "00:00") return;

                const sign = timeStr.startsWith('-') ? -1 : 1;
                const [hours, minutes] = timeStr.replace(/[-+]/, '').split(':').map(Number);
                
                if (!isNaN(hours) && !isNaN(minutes)) {
                    totalMonthOvertime += (hours * 60 + minutes) * sign;
                }
            });

            const totalCell = document.getElementById('total-overtime');
            totalCell.textContent = formatMinutes(totalMonthOvertime, true);

            totalCell.classList.remove('text-green-600', 'text-red-600', 'text-gray-900');
            if (totalMonthOvertime > 0) {
                totalCell.classList.add('text-green-600');
            } else if (totalMonthOvertime < 0) {
                totalCell.classList.add('text-red-600');
            } else {
                totalCell.classList.add('text-gray-900');
            }
        }

        // --- FUNÇÃO DE EXPORTAÇÃO XLSX (MANTIDA) ---
        window.exportToXLSX = function() {
            if (typeof XLSX === 'undefined') {
                console.error("SheetJS (XLSX) não foi carregado. A exportação falhou.");
                return;
            }

            const tableBody = document.getElementById('sheet-body');
            const monthText = monthSelect.options[monthSelect.selectedIndex].text;
            const yearText = yearSelect.value;
            const monthYear = `${monthText}/${yearText}`;

            const aoaData = [];
            
            aoaData.push(["Planilha de Horas Extras - Estúdio Infocus", "", monthYear]); 
            aoaData.push([]); 
            
            aoaData.push([
                "Data", "Dia", "Entrada Mat.", "Saída Mat.", "Entrada Vesp.", "Saída Vesp.", 
                "Total Trabalhado", "Horas Extras", "Base Diária (Min)"
            ]); 

            let excelRow = 4; 

            tableBody.querySelectorAll('tr').forEach(row => {
                const baseMinutes = row.dataset.baseMinutes;
                const dayIndex = row.id.replace('row-', '');
                
                const dateCell = row.cells[0].textContent;
                const dayOfWeekCell = row.cells[1].textContent;
                
                const in1 = currentMonthData[dayIndex]?.in1 || '';
                const out1 = currentMonthData[dayIndex]?.out1 || '';
                const in2 = currentMonthData[dayIndex]?.in2 || '';
                const out2 = currentMonthData[dayIndex]?.out2 || '';

                const totalWorkedFormula = `=(D${excelRow}-C${excelRow})+(F${excelRow}-E${excelRow})`;
                const overtimeFormula = `=G${excelRow}-(I${excelRow}/1440)`;

                aoaData.push([
                    dateCell, 
                    dayOfWeekCell, 
                    in1, 
                    out1, 
                    in2, 
                    out2, 
                    { f: totalWorkedFormula, t: 'n' }, 
                    { f: overtimeFormula, t: 'n' },    
                    Number(baseMinutes)                 
                ]);
                excelRow++;
            });
            
            const totalRow = excelRow + 1; 
            const totalOvertimeFormula = `=SUM(H5:H${excelRow - 1})`;

            aoaData.push([]); 
            aoaData.push([
                "Saldo Total de Horas Extras", "", "", "", "", "", "", { f: totalOvertimeFormula, t: 'n' }
            ]);

            const worksheet = XLSX.utils.aoa_to_sheet(aoaData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Planilha Horas");

            worksheet['!cols'] = [
                {wch: 10}, {wch: 5}, {wch: 14}, {wch: 14}, {wch: 16}, {wch: 16}, {wch: 15}, {wch: 15}, {wch: 15}
            ];

            for (let i = 5; i < excelRow; i++) {
                if (worksheet[`G${i}`]) worksheet[`G${i}`].z = '[h]:mm';
                if (worksheet[`H${i}`]) worksheet[`H${i}`].z = '+[h]:mm;[Red]-[h]:mm;0';
                for (const col of ['C', 'D', 'E', 'F']) {
                    if (worksheet[`${col}${i}`]) worksheet[`${col}${i}`].z = 'HH:MM'; 
                }
            }

            if (worksheet[`H${totalRow + 1}`]) {
                worksheet[`H${totalRow + 1}`].z = '+[h]:mm;[Red]-[h]:mm;0';
            }
            
            if(worksheet['C1']) {
                 worksheet['C1'].t = 's';
                 worksheet['C1'].v = monthYear;
            }

            XLSX.writeFile(workbook, `Planilha_Horas_Infocus_${monthText}${yearText}.xlsx`);
        }

        // --- FUNÇÃO DE IMPORTAÇÃO XLSX (MANTIDA) ---
        window.handleFileImport = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    
                    const importedData = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });

                    processImportedData(importedData);

                } catch (error) {
                    console.error("Erro ao processar o arquivo XLSX:", error);
                    showMessage("Erro ao processar o arquivo. Certifique-se de que é um arquivo .xlsx válido.");
                }
                event.target.value = ''; 
            };
            reader.readAsArrayBuffer(file);
        }

        function processImportedData(data) {
            const monthYearHeader = data[0] && data[0][2] ? data[0][2] : null;
            if (!monthYearHeader || !monthYearHeader.includes('/')) {
                return showMessage("Formato de arquivo inválido. Não foi possível encontrar o Mês/Ano no cabeçalho (C1).");
            }
            
            const [monthName, yearStr] = monthYearHeader.split('/');
            const year = parseInt(yearStr, 10);
            
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const month = monthNames.findIndex(name => name.toLowerCase() === monthName.toLowerCase()) + 1;

            if (isNaN(year) || month < 1 || month > 12) {
                return showMessage("Mês/Ano inválido no arquivo. Certifique-se de que está no formato 'NomeDoMês/AAAA'.");
            }

            const newMonthData = {};
            let isDataFound = false;

            for (let i = 3; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[0]) continue; 

                const datePart = row[0].split('/')[0]; 
                const day = parseInt(datePart, 10);

                if (isNaN(day) || day < 1 || day > 31) continue;

                const in1 = row[2] || '';
                const out1 = row[3] || '';
                const in2 = row[4] || '';
                const out2 = row[5] || '';

                if (in1 || out1 || in2 || out2) {
                    newMonthData[day.toString()] = { in1, out1, in2, out2 };
                    isDataFound = true;
                }
            }

            if (!isDataFound) {
                 return showMessage("Nenhum dado de horário válido foi encontrado no arquivo.");
            }

            yearSelect.value = year;
            updateMonthSelector(year); 
            monthSelect.value = month;

            saveFullMonthData(year, month, newMonthData);
            
            generateMonthSheet(year, month); 
            
            showMessage(`Dados de ${monthName}/${year} importados com sucesso!`);
        }


        // --- GERAÇÃO DA PLANILHA (MANTIDA) ---

        async function generateMonthSheet(year, month) {
            if (!year || !month) return;

            sheetContainer.innerHTML = '<p class="text-center py-10 text-xl font-medium text-blue-600">Carregando feriados nacionais...</p>';
            sheetFooter.innerHTML = '';

            const nationalHolidayDates = await fetchHolidays(year);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            const savedData = loadMonthData(year, month);
            
            let tableHtml = `
                <table class="min-w-full w-full border-collapse border border-gray-300 shadow-md rounded-lg overflow-hidden">
                    <thead class="bg-gray-100">
                        <tr class="text-center">
                            <th class="py-3 px-2 border border-gray-300 w-1/12">Data</th>
                            <th class="py-3 px-2 border border-gray-300 w-1/12">Dia</th>
                            <th class="py-3 px-2 border border-gray-300 w-2/12">Entrada Mat.</th>
                            <th class="py-3 px-2 border border-gray-300 w-2/12">Saída Mat.</th>
                            <th class="py-3 px-2 border border-gray-300 w-2/12">Entrada Vesp.</th>
                            <th class="py-3 px-2 border border-gray-300 w-2/12">Saída Vesp.</th>
                            <th class="py-3 px-2 border border-gray-300 w-1/12">Total Trab.</th>
                            <th class="py-3 px-2 border border-gray-300 w-1/12">Horas Extras</th>
                        </tr>
                    </thead>
                    <tbody id="sheet-body" class="bg-white">
            `;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay(); 
                const dateStringISO = date.toISOString().split('T')[0]; 
                const dateStringMD = `${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`; 
                
                const dayKey = day.toString();
                const savedEntry = savedData[dayKey] || {}; 

                const isSunday = dayOfWeek === 0;
                const isSaturday = dayOfWeek === 6;
                const isNationalHoliday = nationalHolidayDates.has(dateStringISO);
                const isMunicipalHoliday = MUNICIPAL_HOLIDAYS.hasOwnProperty(dateStringMD); 

                let rowClass = 'text-center';
                let baseMinutes = HORA_BASE_SEMANA; 

                if (isSunday) {
                    rowClass += ' is-sunday'; 
                    baseMinutes = HORA_BASE_DOMINGO; 
                } else if (isMunicipalHoliday) {
                    rowClass += ' is-municipal-holiday'; 
                    baseMinutes = HORA_BASE_FERIADO; 
                } else if (isNationalHoliday) {
                    rowClass += ' is-national-holiday'; 
                    baseMinutes = HORA_BASE_FERIADO; 
                } else if (isSaturday) {
                    baseMinutes = HORA_BASE_SABADO; 
                }

                tableHtml += `
                    <tr id="row-${day}" class="${rowClass}" 
                        data-day-of-week="${dayOfWeek}" 
                        data-is-holiday="${isNationalHoliday}" 
                        data-is-municipal-holiday="${isMunicipalHoliday}"
                        data-base-minutes="${baseMinutes}">
                        <td class="py-2 px-2 border border-gray-200 font-medium">${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}</td>
                        <td class="py-2 px-2 border border-gray-200 font-medium">${DIAS_SEMANA[dayOfWeek]}</td>
                        <td class="py-2 px-2 border border-gray-200"><input type="time" class="time-input" data-col="in1" value="${savedEntry.in1 || ''}"></td>
                        <td class="py-2 px-2 border border-gray-200"><input type="time" class="time-input" data-col="out1" value="${savedEntry.out1 || ''}"></td>
                        <td class="py-2 px-2 border border-gray-200"><input type="time" class="time-input" data-col="in2" value="${savedEntry.in2 || ''}"></td>
                        <td class="py-2 px-2 border border-gray-200"><input type="time" class="time-input" data-col="out2" value="${savedEntry.out2 || ''}"></td>
                        <td class="py-2 px-2 border border-gray-200 font-bold text-gray-700 total-worked">00:00</td>
                        <td class="py-2 px-2 border border-gray-200 font-bold overtime">00:00</td>
                    </tr>
                `;
            }

            tableHtml += `</tbody></table>`;
            sheetContainer.innerHTML = tableHtml;

            sheetFooter.innerHTML = `
                <div class="flex justify-end">
                    <div class="flex items-center space-x-4">
                        <span class="text-lg font-semibold text-gray-800">Saldo Total de Horas Extras:</span>
                        <span id="total-overtime" class="text-2xl font-bold text-gray-900 px-4 py-2 bg-gray-100 rounded-lg">00:00</span>
                    </div>
                </div>
            `;

            document.querySelectorAll('#sheet-body tr').forEach(row => {
                calculateRow(row, false); 
            });
            updateTotalOvertime();

            document.querySelectorAll('.time-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const row = e.target.closest('tr');
                    calculateRow(row, true); 
                });
            });
        }

        // --- FUNÇÕES DE NAVEGAÇÃO E UTILS (MANTIDA) ---

        async function fetchHolidays(year) {
            if (holidaysCache[year]) {
                return holidaysCache[year];
            }
            try {
                const maxRetries = 3;
                let lastError = null;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(`https://brasilapi.com.br/api/feriados/v1/${year}`);
                        if (!response.ok) {
                            throw new Error('Falha na resposta da API.');
                        }
                        const data = await response.json();
                        const holidayDates = new Set(data.map(h => h.date));
                        holidaysCache[year] = holidayDates;
                        return holidayDates;
                    } catch (error) {
                        lastError = error;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
                throw lastError; 
            } catch (error) {
                console.error("Erro fatal ao buscar feriados após várias retentativas:", error);
                holidaysCache[year] = new Set();
                return holidaysCache[year];
            }
        }

        function populateSelectors() {
            const yearOptions = [2025, 2026, 2027];
            
            yearSelect.innerHTML = yearOptions.map(year => `<option value="${year}">Ano ${year}</option>`).join('');

            const initialYear = parseInt(yearSelect.value, 10);
            updateMonthSelector(initialYear);
        }

        function updateMonthSelector(year) {
            const monthNames = [
                "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
            ];
            
            monthSelect.innerHTML = '';
            
            let startMonth = 1; 
            let endMonth = 12; 
            
            if (year === 2025) {
                startMonth = 11; 
            } 

            for (let i = startMonth; i <= endMonth; i++) {
                const monthValue = i.toString();
                const monthName = monthNames[i - 1];
                
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = monthName;
                monthSelect.appendChild(option);
            }

            let targetMonth = monthSelect.dataset.lastSelectedMonth || (year === 2025 ? 11 : 1);
            if (monthSelect.querySelector(`option[value="${targetMonth}"]`)) {
                 monthSelect.value = targetMonth;
            } else {
                monthSelect.value = monthSelect.options[0].value;
            }
            monthSelect.dataset.lastSelectedMonth = monthSelect.value;
        }


        function initApp() {
            const lastYear = localStorage.getItem('lastSelectedYear') || 2025;
            const lastMonth = localStorage.getItem('lastSelectedMonth') || 11;

            populateSelectors(); 

            yearSelect.value = lastYear;
            updateMonthSelector(parseInt(lastYear, 10));
            monthSelect.value = lastMonth;
            monthSelect.dataset.lastSelectedMonth = lastMonth; 

            yearSelect.addEventListener('change', (e) => {
                const newYear = parseInt(e.target.value, 10);
                localStorage.setItem('lastSelectedYear', newYear);
                updateMonthSelector(newYear); 
                const month = parseInt(monthSelect.value, 10);
                localStorage.setItem('lastSelectedMonth', month);
                generateMonthSheet(newYear, month);
            });

            monthSelect.addEventListener('change', (e) => {
                const year = parseInt(yearSelect.value, 10);
                const newMonth = parseInt(e.target.value, 10);
                monthSelect.dataset.lastSelectedMonth = newMonth;
                localStorage.setItem('lastSelectedMonth', newMonth);
                generateMonthSheet(year, newMonth);
            });

            const initialYear = parseInt(yearSelect.value, 10);
            const initialMonth = parseInt(monthSelect.value, 10);
            generateMonthSheet(initialYear, initialMonth);
        }

        initApp(); 

    </script>
</body>
</html>
